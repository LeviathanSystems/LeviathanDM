name: CI Build and Test

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            /usr/lib/x86_64-linux-gnu/libwayland*.so*
            /usr/lib/x86_64-linux-gnu/libpixman*.so*
            /usr/lib/x86_64-linux-gnu/pkgconfig/wayland*.pc
            /usr/lib/x86_64-linux-gnu/pkgconfig/pixman*.pc
            /usr/include/wayland
            /usr/include/pixman-1
            /usr/share/wayland
            /usr/share/pkgconfig/wayland*.pc
            /usr/bin/wayland-scanner
          key: deps-${{ runner.os }}-wayland-1.23.1-pixman-0.43.4-v1
          restore-keys: |
            deps-${{ runner.os }}-wayland-1.23.1-pixman-0.43.4-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake meson ninja-build pkg-config \
            ccache \
            libxkbcommon-dev \
            libpixman-1-dev libdrm-dev libgbm-dev libudev-dev \
            libinput-dev libseat-dev hwdata \
            libcairo2-dev libpango1.0-dev libglib2.0-dev \
            libegl1-mesa-dev libgles2-mesa-dev \
            libvulkan-dev glslang-tools \
            libxcb1-dev libxcb-composite0-dev libxcb-render0-dev \
            libxcb-xfixes0-dev libxcb-xinput-dev libxcb-image0-dev \
            libxcb-dri3-dev libxcb-present-dev libxcb-sync-dev \
            libxcb-render-util0-dev \
            libxcb-ewmh-dev libxcb-icccm4-dev libx11-xcb-dev \
            libxml2-dev libexpat1-dev libffi-dev \
            libyaml-cpp-dev
          # Remove old wayland-protocols so wlroots uses vendored version
          sudo apt-get remove -y wayland-protocols || true

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Build wayland 1.23.1 from source
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          wget https://gitlab.freedesktop.org/wayland/wayland/-/releases/1.23.1/downloads/wayland-1.23.1.tar.xz
          tar -xf wayland-1.23.1.tar.xz
          cd wayland-1.23.1
          meson setup build --prefix=/usr -Ddocumentation=false
          ninja -C build
          sudo ninja -C build install

      - name: Build pixman 0.43.4 from source
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          wget https://www.cairographics.org/releases/pixman-0.43.4.tar.gz
          tar -xf pixman-0.43.4.tar.gz
          cd pixman-0.43.4
          meson setup build --prefix=/usr -Dgtk=disabled -Dlibpng=disabled
          ninja -C build
          sudo ninja -C build install

      - name: Update library cache
        run: sudo ldconfig

      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: |
            build
            !build/compile_commands.json
          key: cmake-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', 'subprojects/**') }}-${{ github.sha }}
          restore-keys: |
            cmake-${{ runner.os }}-${{ hashFiles('**/CMakeLists.txt', 'subprojects/**') }}-
            cmake-${{ runner.os }}-

      - name: Setup dependencies
        run: ./setup-deps.sh

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                ..

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Check for warnings
        run: |
          echo "Checking build output for warnings..."
          # This is informational - we don't fail on warnings yet
          if [ -f build/compile_commands.json ]; then
            echo "✓ Compile commands generated"
          fi

      - name: Verify binaries
        run: |
          test -f build/leviathan || (echo "❌ Main binary not built" && exit 1)
          test -f build/leviathanctl || (echo "❌ Control binary not built" && exit 1)
          test -f build/libleviathan-ui.so || (echo "❌ UI library not built" && exit 1)
          echo "✓ All binaries built successfully"

      - name: Build plugins
        run: |
          cd plugins
          ./build-all.sh
          echo "✓ Plugins built successfully"

      - name: Check file sizes
        run: |
          echo "Binary sizes:"
          ls -lh build/leviathan build/leviathanctl build/libleviathan-ui.so

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" src/ include/ || echo "No TODO/FIXME found"

      - name: Check file permissions
        run: |
          echo "Checking for executable scripts..."
          find . -name "*.sh" -type f ! -perm -u+x -print || true

      - name: Validate config files
        run: |
          echo "Checking YAML config files..."
          for file in config/*.yaml; do
            if [ -f "$file" ]; then
              echo "✓ Found config: $file"
            fi
          done
